#!/usr/bin/env bash

abspath="$(cd "${0%/*}" 2>/dev/null; echo "$PWD"/"${0##*/}")"
bin_dir=`dirname $abspath`
root_dir=`dirname $bin_dir`

cd $root_dir

if [[ ! -e dist ]]; then
  echo "Cannot find dist directory"
  exit 1
fi

$bin_dir/check_patches || exit 1

if [[ ! -d working ]]; then
  mkdir working
  pushd working
  git init
  git pull .. master
  git rev-parse HEAD > .git/.baseline
  popd
else
  pushd working
  git reset --hard `cat .git/.baseline`
  popd
fi

cd working || exit 1

for patch in `ls ../patches/*.patch | sort`; do
  number=`basename $patch | cut -f 1 -d -`
  git am $patch || exit 1
  mkdir -p $root_dir/dist/$number
  cp -r p* bin $root_dir/dist/$number/
done

pushd $root_dir/dist
svn stat | grep '?' | awk '{ print $2 }' | xargs svn add --force
svn stat | grep '!' | awk '{ print $2 }' | xargs svn rm
popd
