From 75c1ce726b2fc54a85e7c4792f483f6a3126e6f6 Mon Sep 17 00:00:00 2001
From: Ben Rady <benrady@gmail.com>
Date: Fri, 20 Nov 2015 11:36:14 -0600
Subject: [PATCH 1/2] Added popular answers microservice function

---
 services/lib/deploy.js      |  5 +++--
 services/lib/index.js       | 32 ++++++++++++++++++++++++++++++++
 services/spec/index_spec.js | 31 ++++++++++++++++++++++++++++++-
 3 files changed, 65 insertions(+), 3 deletions(-)

diff --git a/services/lib/deploy.js b/services/lib/deploy.js
index fcf7007..0bd4e8e 100644
--- a/services/lib/deploy.js
+++ b/services/lib/deploy.js
@@ -1,11 +1,12 @@
 var AWS = require('aws-sdk');
 var fs = require('fs');
-var config = require('../conf/' + process.argv[2] + '.js');
 
 AWS.config.region = 'us-east-1'
+var functionName = 'arn:aws:lambda:us-east-1:730171000947:function:learnjs_popularAnswers'
+
 var lambda = new AWS.Lambda({apiVersion: '2015-03-31'});
 var params = {
-  FunctionName: config.functionName, 
+  FunctionName: functionName,
   ZipFile: fs.readFileSync('archive.zip')
 };
 lambda.updateFunctionCode(params, function(err, data) { 
diff --git a/services/lib/index.js b/services/lib/index.js
index 597b7be..cc3013c 100644
--- a/services/lib/index.js
+++ b/services/lib/index.js
@@ -1,3 +1,34 @@
+var http = require('http');
+var AWS = require('aws-sdk');
+
+AWS.config.region = 'us-east-1';
+
+var config = {
+  dynamoTableName: 'learnjs',
+};
+
+exports.dynamodb = new AWS.DynamoDB.DocumentClient();
+
+function reduceItems(memo, items) {
+  items.forEach(function(item) {
+    memo[item.answer] = (memo[item.answer] || 0) + 1;
+  });
+  return memo;
+}
+
+exports.fetchPopularAnswers = function(json, context) {
+  exports.dynamodb.scan({
+    Key: {problemNumber: json.problemNumber},
+    TableName: config.dynamoTableName
+  }, function(err, data) {
+    if (err) {
+      context.fail(err);
+    } else {
+      context.succeed(reduceItems({}, data.Items));
+    }
+  });
+};
+
 exports.echo = function(json, context) {  
   context.succeed(["Hello from the cloud! You sent " + JSON.stringify(json)]);
 };
diff --git a/services/spec/index_spec.js b/services/spec/index_spec.js
index d763979..1f5b3ba 100644
--- a/services/spec/index_spec.js
+++ b/services/spec/index_spec.js
@@ -3,7 +3,8 @@ describe('lambda function', function() {
   var context;
 
   beforeEach(function() {
-    context = jasmine.createSpyObj('context', ['succeed']);
+    context = jasmine.createSpyObj('context', ['succeed', 'fail']);
+    index.dynamodb = jasmine.createSpyObj('dynamo', ['scan']);
   });
 
   describe('echo', function() {
@@ -13,4 +14,32 @@ describe('lambda function', function() {
       expect(context.succeed).toHaveBeenCalledWith(expected);
     });
   });
+
+  describe('fetchPopularAnswers', function() {
+    it('requests problems with the given problem number', function() {
+      index.fetchPopularAnswers({problemNumber: 42}, context);
+      expect(index.dynamodb.scan).toHaveBeenCalledWith({
+        Key: {problemNumber: 42},
+        TableName: 'learnjs'
+      }, jasmine.any(Function));
+    });
+
+    it('groups answers by minified code', function() {
+      index.fetchPopularAnswers({problemNumber: 1}, context);
+      index.dynamodb.scan.calls.first().args[1](undefined, {Items: [
+        {answer: "true"},
+        {answer: "true"},
+        {answer: "true"},
+        {answer: "!false"},
+        {answer: "!false"},
+      ]});
+      expect(context.succeed).toHaveBeenCalledWith({"true": 3, "!false": 2});
+    });
+
+    it('fails the request if dynamo returns an error', function() {
+      index.fetchPopularAnswers({problemNumber: 1}, context);
+      index.dynamodb.scan.calls.first().args[1]('error');
+      expect(context.fail).toHaveBeenCalledWith('error')
+    });
+  });
 });
-- 
1.9.1

