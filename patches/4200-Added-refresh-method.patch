From caaa3610fdfbc0608b5753295f7993f3ca57ccf2 Mon Sep 17 00:00:00 2001
From: Ben Rady <benrady@gmail.com>
Date: Tue, 29 Sep 2015 16:53:02 -0500
Subject: [PATCH] Added refresh method

---
 public/app.js            | 19 +++++++++++++++----
 public/tests/app_spec.js | 37 ++++++++++++++++++++++++++++++++++++-
 2 files changed, 51 insertions(+), 5 deletions(-)

diff --git a/public/app.js b/public/app.js
index eba60b0..613fb5a 100644
--- a/public/app.js
+++ b/public/app.js
@@ -164,7 +164,7 @@ learnjs.awsRefresh = function() {
       deferred.resolve(AWS.config.credentials.identityId);
     }
   });
-  return deferred;
+  return deferred.promise();
 }
 // END: awsRefresh
 
@@ -180,12 +180,23 @@ function googleSignIn(googleUser) {
       }
     })
   })
-// END: googleSignIn
+  // END: googleSignIn
+  // START: gapi-refresh
+  function refresh() {
+    return gapi.auth2.getAuthInstance().signIn({prompt: 'login'}).then(function(userUpdate) {
+      var creds = AWS.config.credentials;
+      var newToken = userUpdate.getAuthResponse().id_token;
+      creds.params.Logins['accounts.google.com'] = newToken;
+      return learnjs.awsRefresh();
+    });
+  }
+  // END: gapi-refresh
   // START: googleSignIn-getId
-  $.when(learnjs.awsRefresh()).then(function(id) {
+  learnjs.awsRefresh().then(function(id) {
     learnjs.identity.resolve({
       id: id,
-      email: googleUser.getBasicProfile().getEmail()
+      email: googleUser.getBasicProfile().getEmail(),
+      refresh: refresh
     });
   });
   // END: googleSignIn-getId
diff --git a/public/tests/app_spec.js b/public/tests/app_spec.js
index 8469d6c..affb750 100644
--- a/public/tests/app_spec.js
+++ b/public/tests/app_spec.js
@@ -130,7 +130,8 @@ describe('LearnJS', function() {
 
     beforeEach(function() {
       profile = jasmine.createSpyObj('profile', ['getEmail']);
-      spyOn(learnjs, 'awsRefresh').and.returnValue(new $.Deferred().resolve("COGNITO_ID"));
+      var refreshPromise = new $.Deferred().resolve("COGNITO_ID").promise();
+      spyOn(learnjs, 'awsRefresh').and.returnValue(refreshPromise);
       spyOn(AWS, 'CognitoIdentityCredentials');
       user = jasmine.createSpyObj('user',
           ['getAuthResponse', 'getBasicProfile']);
@@ -160,6 +161,40 @@ describe('LearnJS', function() {
         done();
       });
     });
+
+    describe('refresh', function() {
+      var instanceSpy;
+      beforeEach(function() {
+        AWS.config.credentials = {params: {Logins: {}}};
+        var updateSpy = jasmine.createSpyObj('userUpdate', ['getAuthResponse']);
+        updateSpy.getAuthResponse.and.returnValue({id_token: "GOOGLE_ID"});
+        instanceSpy = jasmine.createSpyObj('instance', ['signIn']);
+        instanceSpy.signIn.and.returnValue(Promise.resolve(updateSpy));
+        var auth2Spy = jasmine.createSpyObj('auth2', ['getAuthInstance']);
+        auth2Spy.getAuthInstance.and.returnValue(instanceSpy);
+        window.gapi = { auth2: auth2Spy };
+      });
+
+      it('returns a promise when token is refreshed', function(done) {
+        learnjs.identity.done(function(identity) {
+          identity.refresh().then(function() {
+            expect(AWS.config.credentials.params.Logins).toEqual({
+              'accounts.google.com': "GOOGLE_ID"
+            });
+            done();
+          });
+        });
+      });
+
+      it('does not re-prompt for consent when refreshing the token in', function(done) {
+        learnjs.identity.done(function(identity) {
+          identity.refresh().then(function() {
+            expect(instanceSpy.signIn).toHaveBeenCalledWith({prompt: 'login'});
+            done();
+          });
+        });
+      });
+    });
   });
   // END: googleSignIn
 
-- 
2.3.8 (Apple Git-58)

