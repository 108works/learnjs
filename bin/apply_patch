#!/usr/bin/env bash

abspath="$(cd "${0%/*}" 2>/dev/null; echo "$PWD"/"${0##*/}")"
bin_dir=`dirname $abspath`
root_dir=`dirname $bin_dir`

cd $root_dir

patch=$1

if [[ ! -e $patch ]]; then
  echo "$patch does not exist"
  exit 1
fi

if [[ ! -d working ]]; then
  mkdir working
  pushd working
  git init
  git pull .. master
  git rev-parse HEAD > .git/.baseline
  popd
else
  pushd working
  git reset --hard `cat .git/.baseline`
  popd
fi

cd working || exit 1

for patch_file in `ls $root_dir/patches/* | sort`; do
  if [[ `basename $patch_file` < `basename $patch` ]]; then
    git am $patch_file || exit 1
  fi
done
git am $root_dir/patches/`basename $patch`

echo "Patches applied successfully"
