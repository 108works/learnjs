From 571c0d686bcc7cbfb0d77afcffa309229c1ed045 Mon Sep 17 00:00:00 2001
From: Ben Rady <benrady@gmail.com>
Date: Thu, 20 Aug 2015 21:48:07 -0500
Subject: [PATCH] Added identity deferred

---
 public/app.js            | 28 ++++++++++++++++++++++++++++
 public/tests/app_spec.js | 44 ++++++++++++++++++++++++++++++++++++++------
 2 files changed, 66 insertions(+), 6 deletions(-)

diff --git a/public/app.js b/public/app.js
index ff49215..eba60b0 100644
--- a/public/app.js
+++ b/public/app.js
@@ -6,6 +6,10 @@ var learnjs = {
 };
 // END: namespace
 
+// START: identityDeferred
+learnjs.identity = new $.Deferred();
+// END: identityDeferred
+
 //START: dataModel
 learnjs.problems = [
   {
@@ -150,6 +154,20 @@ learnjs.appOnReady = function() {
 }
 // END: appOnReady
 
+// START: awsRefresh
+learnjs.awsRefresh = function() {
+  var deferred = new $.Deferred();
+  AWS.config.credentials.refresh(function(err) {
+    if (err) {
+      deferred.reject(err);
+    } else {
+      deferred.resolve(AWS.config.credentials.identityId);
+    }
+  });
+  return deferred;
+}
+// END: awsRefresh
+
 // START: googleSignIn
 function googleSignIn(googleUser) {
   var id_token = googleUser.getAuthResponse().id_token;
@@ -162,5 +180,15 @@ function googleSignIn(googleUser) {
       }
     })
   })
+// END: googleSignIn
+  // START: googleSignIn-getId
+  $.when(learnjs.awsRefresh()).then(function(id) {
+    learnjs.identity.resolve({
+      id: id,
+      email: googleUser.getBasicProfile().getEmail()
+    });
+  });
+  // END: googleSignIn-getId
+// START: googleSignIn
 }
 // END: googleSignIn
diff --git a/public/tests/app_spec.js b/public/tests/app_spec.js
index 579bd36..8469d6c 100644
--- a/public/tests/app_spec.js
+++ b/public/tests/app_spec.js
@@ -77,6 +77,31 @@ describe('LearnJS', function() {
     expect(callback.calls.argsFor(0)[1]).toEqual('bar');
   });

+  describe('awsRefresh', function() {
+    var callbackArg, fakeCreds;
+
+    beforeEach(function() {
+      fakeCreds = jasmine.createSpyObj('creds', ['refresh']);
+      fakeCreds.identityId = 'COGNITO_ID';
+      AWS.config.credentials = fakeCreds;
+      fakeCreds.refresh.and.callFake(function(cb) { cb(callbackArg); });
+    });
+
+    it('returns a promise that resolves on success', function(done) {
+      learnjs.awsRefresh().then(function(id) {
+        expect(fakeCreds.identityId).toEqual('COGNITO_ID');
+      }).then(done, fail);
+    });
+
+    it('rejects the promise on a failure', function(done) {
+      callbackArg = 'error';
+      learnjs.awsRefresh().fail(function(err) {
+        expect(err).toEqual("error");
+        done();
+      });
+    });
+  });
+
   // START: profileView
   describe('profile view', function() {
     var view;
@@ -101,15 +126,14 @@ describe('LearnJS', function() {
 
   // START: googleSignIn
   describe('googleSignIn callback', function() {
-    var user, fakeCreds;
+    var user, profile;
 
     beforeEach(function() {
       profile = jasmine.createSpyObj('profile', ['getEmail']);
-      fakeCreds = jasmine.createSpyObj('creds', ['refresh']);
-      fakeCreds.refresh.and.callFake(function(c) { c() });
-      fakeCreds.identityId = "COGNITO_ID"
-      spyOn(AWS, 'CognitoIdentityCredentials').and.returnValue(fakeCreds);
-      user = jasmine.createSpyObj('user', ['getAuthResponse', 'getBasicProfile']);
+      spyOn(learnjs, 'awsRefresh').and.returnValue(new $.Deferred().resolve("COGNITO_ID"));
+      spyOn(AWS, 'CognitoIdentityCredentials');
+      user = jasmine.createSpyObj('user',
+          ['getAuthResponse', 'getBasicProfile']);
       user.getAuthResponse.and.returnValue({id_token: 'GOOGLE_ID'});
       user.getBasicProfile.and.returnValue(profile);
       profile.getEmail.and.returnValue('foo@bar.com');
@@ -128,6 +152,14 @@ describe('LearnJS', function() {
         }
       });
     });
+
+    it('fetches the AWS credentials and resolved the deferred', function(done) {
+      learnjs.identity.done(function(identity) {
+        expect(identity.email).toEqual('foo@bar.com');
+        expect(identity.id).toEqual('COGNITO_ID');
+        done();
+      });
+    });
   });
   // END: googleSignIn
 
-- 
2.3.8 (Apple Git-58)

