#!/usr/bin/env bash

abspath="$(cd "${0%/*}" 2>/dev/null; echo "$PWD"/"${0##*/}")"
bin_dir=`dirname $abspath`
root_dir=`dirname $bin_dir`

cd $root_dir

patch=$1

master_commit=`git rev-parse master`

if [[ ! -d working ]]; then
  mkdir working
  pushd working
  git init
  git pull .. master
  popd
else
  pushd working
  git pull .. master
  git reset --hard $master_commit
  popd
fi

cd working || exit 1

for patch_file in `ls $root_dir/patches/* | sort`; do
  if [[ -f "../${patch}" ]]; then
    if [[ `basename $patch_file` < `basename $patch` ]]; then
      git am $patch_file || exit 1
    fi
  fi
done
if [[ -f "../${patch}" ]]; then
  git am $root_dir/patches/`basename $patch`
fi

echo "Patches applied successfully"
